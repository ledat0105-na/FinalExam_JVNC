<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Chi tiết đơn hàng | UCOP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Chi tiết đơn hàng <span class="text-primary"
                    th:text="'#' + ${order.orderNumber}">#ORD-123</span></h2>
            <a th:href="@{/customer/orders}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
        </div>

        <div class="row g-4">
            <!-- Order Details -->
            <div class="col-lg-8">
                <!-- Order Status Card -->
                <!-- Order Tracking Timeline -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4 text-center">Tiến độ đơn hàng</h5>
                        <div class="timeline-steps">
                            <div class="step"
                                th:classappend="${order.status == 'PENDING_CONFIRMATION' or order.status == 'CONFIRMED' or order.status == 'SHIPPING' or order.status == 'DONE' ? 'active' : ''}">
                                <div class="step-icon-wrap">
                                    <i class="bi bi-cart"></i>
                                </div>
                                <h4 class="step-title">Đặt hàng</h4>
                            </div>
                            <div class="step"
                                th:classappend="${order.status == 'CONFIRMED' or order.status == 'SHIPPING' or order.status == 'DONE' ? 'active' : ''}">
                                <div class="step-icon-wrap">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <h4 class="step-title">Xác nhận</h4>
                            </div>
                            <div class="step"
                                th:classappend="${order.status == 'SHIPPING' or order.status == 'DONE' ? 'active' : ''}">
                                <div class="step-icon-wrap">
                                    <i class="bi bi-truck"></i>
                                </div>
                                <h4 class="step-title">Vận chuyển</h4>
                            </div>
                            <div class="step" th:classappend="${order.status == 'DONE' ? 'active' : ''}">
                                <div class="step-icon-wrap">
                                    <i class="bi bi-house-door"></i>
                                </div>
                                <h4 class="step-title">Hoàn thành</h4>
                            </div>
                        </div>

                        <!-- Cancelled/Failed Alert -->
                        <div th:if="${order.status == 'CANCELLED' or order.status == 'FAILED'}"
                            class="alert alert-danger mt-3 text-center border-0 bg-danger bg-opacity-10 text-danger fw-bold">
                            <i class="bi bi-x-circle me-2"></i> Đơn hàng đã bị hủy hoặc thất bại
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-4">
                            <!-- Cancel Button -->
                            <div th:if="${order.status == 'PENDING_CONFIRMATION'}" class="d-inline-block">
                                <form th:action="@{'/customer/orders/' + ${order.orderId} + '/cancel'}" method="post"
                                    onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này không?');">
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="bi bi-x-circle me-2"></i>Hủy đơn hàng
                                    </button>
                                </form>
                            </div>

                            <!-- Refund Button -->
                            <div th:if="${(order.status == 'CANCELLED' or order.status == 'FAILED') and order.refundId == null}"
                                class="d-inline-block">
                                <form th:action="@{'/customer/orders/' + ${order.orderId} + '/refund'}" method="post"
                                    onsubmit="return confirm('Bạn có chắc chắn muốn yêu cầu hoàn tiền cho đơn hàng này không?');">
                                    <button type="submit" class="btn btn-warning text-white fw-bold">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Yêu cầu hoàn tiền
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Refund Status -->
                        <div class="mt-3 alert alert-success border-0 bg-success bg-opacity-10 text-success fw-bold text-center"
                            th:if="${order.refundId != null}">
                            <i class="bi bi-check-circle me-2"></i> Yêu cầu hoàn tiền đã được gửi.
                        </div>

                        <p class="text-muted text-center mb-0 mt-3 small">Mã đơn hàng: <span class="fw-bold text-dark"
                                th:text="${order.orderNumber}">#ORD</span> • Ngày đặt: <span class="fw-bold text-dark"
                                th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    </div>
                </div>

                <!-- Shipment Info -->
                <div class="card mb-4 border-0 shadow-sm" th:if="${not #lists.isEmpty(order.shipments)}">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold mb-0 text-primary"><i class="bi bi-truck me-2"></i>Thông tin vận chuyển</h5>
                    </div>
                    <div class="card-body p-4">
                        <div th:each="shipment : ${order.shipments}" class="mb-3 pb-3 border-bottom last-no-border">
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Đơn vị vận chuyển</small>
                                    <span class="fw-bold" th:text="${shipment.carrier}">GiaoHangNhanh</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Mã vận đơn</small>
                                    <span class="fw-bold font-monospace"
                                        th:text="${shipment.trackingNumber}">GHN12345678</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Trạng thái vận chuyển</small>
                                    <span class="badge bg-info text-dark" th:text="${shipment.status}">Đang giao</span>
                                </div>
                            </div>
                            <div class="mt-3 text-muted small">
                                <i class="bi bi-clock-history me-1"></i> Cập nhật gần nhất:
                                <span th:text="${#temporals.format(shipment.shippedAt, 'dd/MM/yyyy HH:mm')}"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info border-0 shadow-sm" th:if="${#lists.isEmpty(order.shipments)}">
                    <i class="bi bi-info-circle me-2"></i> Đơn hàng chưa có thông tin vận chuyển.
                </div>


                <!-- Items List -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold mb-0">Sản phẩm đã đặt</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Sản phẩm</th>
                                        <th class="text-center">Đơn giá</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end pe-4">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item : ${order.items}">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-light rounded p-2 me-3 d-flex align-items-center justify-content-center"
                                                    style="width: 48px; height: 48px;">
                                                    <i class="bi bi-box-seam text-secondary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold" th:text="${item.itemName}">Item Name</h6>
                                                    <small class="text-muted" th:text="${item.sku}">SKU</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center"
                                            th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                                            100,000 đ</td>
                                        <td class="text-center" th:text="${item.quantity}">2</td>
                                        <td class="text-end pe-4 fw-bold"
                                            th:text="${#numbers.formatDecimal(item.lineTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                                            200,000 đ</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold mb-0">Địa chỉ nhận hàng</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1 fw-bold" th:text="${order.customerUsername}">User Name</p>
                        <!-- In real app, real name -->
                        <p class="text-muted mb-0" th:text="${order.shippingAddress}">So 1 Dai Co Viet, Ha Noi</p>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="fw-bold card-title mb-4">Tổng cộng</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tạm tính</span>
                            <span class="fw-bold"
                                th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">0
                                đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" th:if="${order.discountTotal > 0}">
                            <span class="text-muted">Giảm giá</span>
                            <span class="text-success"
                                th:text="'-' + ${#numbers.formatDecimal(order.discountTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">-0
                                đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" th:if="${order.shippingFee > 0}">
                            <span class="text-muted">Phí vận chuyển</span>
                            <span class="text-dark"
                                th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' đ'">0
                                đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4" th:if="${order.taxAmount > 0}">
                            <span class="text-muted">Thuế</span>
                            <span class="text-dark"
                                th:text="${#numbers.formatDecimal(order.taxAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'">0
                                đ</span>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between mb-0">
                            <span class="fw-bold fs-5">Thành tiền</span>
                            <span class="fw-bold fs-5 text-primary"
                                th:text="${#numbers.formatDecimal(order.grandTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">0
                                đ</span>
                        </div>
                        <div class="mt-3 pt-2 text-center border-top">
                            <small class="text-muted">Phương thức thanh toán: <strong
                                    th:text="${order.paymentMethod}">COD</strong></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .last-no-border:last-child {
            border-bottom: 0 !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }
    </style>
</body>

</html>